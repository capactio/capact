apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "voltron.fullname" . }}-test-e2e"
  labels:
  {{- include "voltron.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  serviceAccountName: "{{ include "voltron.fullname" . }}-test-e2e"
  containers:
    - name: tests-runner
      image: "{{ .Values.global.containerRegistry.path }}/{{ .Values.integrationTest.image.name }}:{{ .Values.global.containerRegistry.overrideTag | default .Chart.AppVersion }}"
      env:
        - name: STATUS_ENDPOINTS
          value: "http://voltron-engine-graphql.{{.Release.Namespace}}.svc.cluster.local/healthz,http://voltron-gateway.{{.Release.Namespace}}.svc.cluster.local/healthz,http://voltron-och-local.{{.Release.Namespace}}.svc.cluster.local/healthz,http://voltron-och-public.{{.Release.Namespace}}.svc.cluster.local/healthz"
        - name: IGNORED_PODS_NAMES
          value: "{{ .Release.Namespace}}/{{ include "voltron.fullname" . }}-test-e2e"
        - name: EXPECTED_NUMBER_OF_RUNNING_PODS
          value: "{{ .Values.integrationTest.expectedNumberOfRunningPods }}"
        - name: GATEWAY_ENDPOINT
          value: "http://voltron-gateway.{{.Release.Namespace}}.svc.cluster.local/graphql"
        - name: GATEWAY_USERNAME
          value: "{{ .Values.global.gateway.auth.username }}"
        - name: GATEWAY_PASSWORD
          value: "{{ .Values.global.gateway.auth.password }}"
        - name: APP_CLUSTER_POLICY_NAME
          value: {{ include "voltron.fullname" . }}-engine-cluster-policy
        - name: APP_CLUSTER_POLICY_NAMESPACE
          value: {{.Release.Namespace}}
      imagePullPolicy: {{ .Values.integrationTest.image.pullPolicy }}
  restartPolicy: Never
